import:
  - recipe/laravel.php

config:
  application: 'lasteaiapildid'
  repository: 'git@github.com:Anne-dot/lasteaiapildid-web.git'
  git_tty: true
  keep_releases: 3
  
  # Laravel specific
  shared_files:
    - .env
  shared_dirs:
    - storage

hosts:
  production:
    hostname: lasteaiapildid.ee
    remote_user: virt139054
    deploy_path: '~/deployments/{{application}}'
    branch: main
    
tasks:
  deploy:
    - deploy:prepare
    - deploy:vendors
    - artisan:storage:link
    - artisan:config:cache
    - artisan:route:cache
    - artisan:view:cache
    - artisan:migrate
    - npm:install
    - npm:build
    - deploy:publish
    
  npm:install:
    - run: 'cd {{release_path}} && npm ci'
    
  npm:build:
    - run: 'cd {{release_path}} && npm run build'
      
  deploy:update_code:
    - run: 'git clone --depth 1 --branch {{branch}} {{repository}} {{release_path}}'
    - run: 'cd {{release_path}} && cp -r lasteaiapildid-web/* . && cp -r lasteaiapildid-web/.[^.]* . 2>/dev/null || true && rm -rf lasteaiapildid-web'
    
  deploy:writable:
    - run: 'echo "Skipping writable task - not needed on Zone.eu"'
